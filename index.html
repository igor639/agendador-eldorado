<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4f46e5">
    <title>Agendador PRO</title>
    
    <style>
        :root {
            --primary: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light);
            padding-bottom: 80px;
        }

        body.dark {
            --light: #1e293b;
            --dark: #f8fafc;
            background: #0f172a;
            color: #f8fafc;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .theme-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
        }

        .clock {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .clock-time {
            font-size: 24px;
            font-weight: bold;
        }

        .clock-date {
            font-size: 14px;
            margin-top: 5px;
        }

        .assistant-select {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .assistant-select option {
            color: #1e293b;
        }

        .container {
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .dark .card {
            background: #1e293b;
        }

        .card h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--success);
            color: white;
        }

        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .recipient-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark .recipient-card {
            background: #0f172a;
        }

        .recipient-info strong {
            display: block;
            margin-bottom: 5px;
        }

        .recipient-info small {
            color: #64748b;
            font-size: 14px;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .conversion-card {
            background: linear-gradient(135deg, #ec4899, #be185d);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .conversion-rate {
            font-size: 48px;
            font-weight: bold;
            margin: 15px 0;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 5px;
        }

        .filter-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            font-weight: bold;
        }

        .dark .filter-tab {
            background: #1e293b;
            border-color: #334155;
        }

        .filter-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .appointment-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #e2e8f0;
        }

        .dark .appointment-card {
            background: #1e293b;
        }

        .appointment-card.confirmed {
            border-left-color: var(--success);
            background: #f0fdf4;
        }

        .dark .appointment-card.confirmed {
            background: #14532d;
        }

        .appointment-card.pending {
            border-left-color: var(--warning);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }

        .status-confirmada {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            z-index: 99;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .dark .bottom-nav {
            background: #1e293b;
        }

        .nav-item {
            background: none;
            border: none;
            color: #64748b;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 10px;
        }

        .nav-item.active {
            color: var(--primary);
            background: #eef2ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            align-items: flex-end;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 25px 25px 0 0;
            padding: 30px;
            max-height: 85vh;
            overflow-y: auto;
            width: 100%;
        }

        .dark .modal-content {
            background: #1e293b;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .hidden {
            display: none !important;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-btn {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <div>
                <h1>Agendador PRO</h1>
                <p>Unidade Eldorado</p>
            </div>
            <button class="theme-btn" onclick="toggleTheme()">üåô</button>
        </div>
        
        <div class="clock">
            <div class="clock-time" id="clock-time">00:00:00</div>
            <div class="clock-date" id="clock-date">Carregando...</div>
        </div>
        
        <select class="assistant-select" id="assistant-name" onchange="updateUI()">
            <option value="">üë§ Selecione seu nome</option>
            <option value="IGOR">Igor</option>
            <option value="DIANA">Diana</option>
            <option value="TATIANA">Tatiana</option>
            <option value="TREINNE">Treinne</option>
            <option value="CAMILE">Camile</option>
            <option value="WELKER">Welker</option>
            <option value="GLEICE">Gleice</option>
            <option value="MARINA">Marina</option>
        </select>
    </div>

    <!-- Tab Agendar -->
    <div id="tab-agendar" class="container">
        <div class="card">
            <h3>üìç Local</h3>
            <select class="input-field" id="location-select">
                <option value="Eldorado">Eldorado</option>
                <option value="Centro">Centro</option>
            </select>
        </div>

        <div class="card">
            <h3>üë• Destinat√°rios (<span id="recipient-count">0</span>)</h3>
            <div id="recipients-list">
                <p style="text-align: center; color: #94a3b8; padding: 40px 0;">
                    Nenhum destinat√°rio<br><small>Toque no + para adicionar</small>
                </p>
            </div>
        </div>

        <button class="btn btn-primary" id="generate-btn" onclick="generateMessages()" disabled>
            ‚úâÔ∏è Gerar Mensagens
        </button>

        <div id="messages-section" class="hidden"></div>
    </div>

    <!-- Tab Gerenciar -->
    <div id="tab-gerenciar" class="container hidden">
        <div class="conversion-card">
            <div>Taxa de Convers√£o</div>
            <div class="conversion-rate" id="conversion-rate">0%</div>
            <div id="conversion-details">0 de 0 total</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stat-total">0</div>
                <div class="stat-label">Total Hoje</div>
            </div>
            <div class="stat-card success">
                <div class="stat-number" id="stat-confirmed">0</div>
                <div class="stat-label">Confirmados</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-number" id="stat-pending">0</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card info">
                <div class="stat-number" id="stat-visited">0</div>
                <div class="stat-label">Compareceram</div>
            </div>
        </div>

        <div class="card">
            <h3>üì§ Exportar Dados</h3>
            <button class="export-btn" onclick="exportExcel()">üìä Exportar Excel</button>
            <button class="export-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </div>

        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterAppointments('all')">Todos</button>
            <button class="filter-tab" onclick="filterAppointments('pending')">Pendentes</button>
            <button class="filter-tab" onclick="filterAppointments('confirmed')">Confirmados</button>
            <button class="filter-tab" onclick="filterAppointments('visited')">Compareceram</button>
        </div>

        <div class="card">
            <input type="search" class="input-field" id="search-input" placeholder="üîç Buscar..." onkeyup="searchAppointments()">
        </div>

        <div id="appointments-list"></div>
    </div>

    <!-- FAB -->
    <button class="fab" onclick="openAddModal()">‚ûï</button>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('agendar')">
            ‚ûï<br>Agendar
        </button>
        <button class="nav-item" onclick="switchTab('gerenciar')">
            üìã<br>Gerenciar
        </button>
    </div>

    <!-- Modal Options -->
    <div id="modal-options" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tipo de Agendamento</h2>
                <button class="modal-close" onclick="closeModal('modal-options')">‚úï</button>
            </div>
            <button class="btn btn-secondary" style="margin-bottom: 10px;" onclick="addRecipient(false)">
                üìÖ Agendamento Normal
            </button>
            <button class="btn" style="background: #f59e0b; color: white;" onclick="addRecipient(true)">
                üî• Puxada (Hoje)
            </button>
        </div>
    </div>

    <!-- Modal Form -->
    <div id="modal-form" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Novo Destinat√°rio</h2>
                <button class="modal-close" onclick="closeModal('modal-form')">‚úï</button>
            </div>
            
            <input type="text" class="input-field" id="input-jovem" placeholder="üë§ Nome do Jovem *" required>
            <input type="text" class="input-field" id="input-nascimento" placeholder="üéÇ Data Nascimento (DD/MM/AAAA)" maxlength="10">
            <input type="text" class="input-field" id="input-responsavel" placeholder="üë®‚Äçüë©‚Äçüë¶ Respons√°vel *" required>
            <input type="tel" class="input-field" id="input-tel-resp" placeholder="üì± Tel. Respons√°vel (5531...)" maxlength="13" required>
            <input type="tel" class="input-field" id="input-tel-jovem" placeholder="üì± Tel. Jovem" maxlength="13">
            
            <div class="form-row">
                <input type="text" class="input-field" id="input-data" placeholder="üìÖ Data *" maxlength="10" required>
                <input type="text" class="input-field" id="input-horario" placeholder="‚è∞ Hor√°rio *" maxlength="5" required>
            </div>
            
            <input type="text" class="input-field" id="input-irmaos" placeholder="üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Irm√£os">
            
            <button class="btn btn-primary" onclick="saveRecipient()">Salvar</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        // ==================== CONFIGURA√á√ÉO ====================
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbw5p93oojhuDCgPpTII9E6jTSoO3L_2X_CxQSEWlYYoa4WTLW9TvXBs_4LDvFPS9qFp0Q/exec',
            SPREADSHEET_ID: '1woX7e4W1a7DjKfQz1ucg3WTSc_xHqi1UdWVEDpIfAEc'
        };

        const ASSISTANT_NAMES = {
            'IGOR': 'Igor Ara√∫jo de Alencar',
            'DIANA': 'Diana D¬¥√Åvila Fagundes',
            'TATIANA': 'Tatiana F. Moretti',
            'TREINNE': 'Treinne',
            'CAMILE': 'Camile da Cruz Monteiro',
            'WELKER': 'Welker Pablo Zanetti',
            'GLEICE': 'Gleice',
            'MARINA': 'Marina'
        };

        let recipients = [];
        let currentRecipient = null;
        let appointments = [];
        let currentFilter = 'all';

        // ==================== CLOCK ====================
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const date = `${days[now.getDay()]}, ${now.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' })}`;
            
            document.getElementById('clock-time').textContent = time;
            document.getElementById('clock-date').textContent = date;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ==================== THEME ====================
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const btn = document.querySelector('.theme-btn');
            btn.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        if (localStorage.getItem('theme') === 'dark') {
            toggleTheme();
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            if (tab === 'agendar') {
                document.getElementById('tab-agendar').classList.remove('hidden');
                document.getElementById('tab-gerenciar').classList.add('hidden');
            } else {
                document.getElementById('tab-agendar').classList.add('hidden');
                document.getElementById('tab-gerenciar').classList.remove('hidden');
                loadAppointments();
            }
        }

        // ==================== MODAL ====================
        function openAddModal() {
            if (!document.getElementById('assistant-name').value) {
                showToast('Selecione seu nome primeiro!', 'error');
                return;
            }
            document.getElementById('modal-options').classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ==================== DATAS ====================
        function getNextDay() {
            const today = new Date();
            const tomorrow = new Date();
            
            if (today.getDay() === 6) {
                tomorrow.setDate(today.getDate() + 2);
            } else if (today.getDay() === 0) {
                tomorrow.setDate(today.getDate() + 1);
            } else {
                tomorrow.setDate(today.getDate() + 1);
            }
            
            return formatDate(tomorrow);
        }

        function getTodayDate() {
            return formatDate(new Date());
        }

        function formatDate(date) {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        // ==================== M√ÅSCARAS ====================
        document.addEventListener('input', (e) => {
            if (e.target.id === 'input-nascimento' || e.target.id === 'input-data') {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length >= 2) v = v.slice(0,2) + '/' + v.slice(2);
                if (v.length >= 5) v = v.slice(0,5) + '/' + v.slice(5);
                e.target.value = v.slice(0,10);
            }
            
            if (e.target.id === 'input-horario') {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length >= 2) v = v.slice(0,2) + ':' + v.slice(2);
                e.target.value = v.slice(0,5);
            }
            
            if (e.target.id === 'input-tel-resp' || e.target.id === 'input-tel-jovem') {
                let v = e.target.value.replace(/\D/g, '');
                if (!v.startsWith('55')) v = '55' + v;
                e.target.value = v.slice(0,13);
            }
        });

        // ==================== RECIPIENTS ====================
        function addRecipient(isPuxada) {
            currentRecipient = {
                id: Date.now().toString(),
                isPuxada: isPuxada
            };
            
            document.getElementById('input-data').value = isPuxada ? getTodayDate() : getNextDay();
            closeModal('modal-options');
            document.getElementById('modal-form').classList.add('show');
        }

        function saveRecipient() {
            const jovem = document.getElementById('input-jovem').value.trim();
            const responsavel = document.getElementById('input-responsavel').value.trim();
            const tel_resp = document.getElementById('input-tel-resp').value.trim();
            const data = document.getElementById('input-data').value.trim();
            const horario = document.getElementById('input-horario').value.trim();
            
            if (!jovem || !responsavel || !tel_resp || !data || !horario) {
                showToast('Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            const recipient = {
                ...currentRecipient,
                jovem,
                responsavel,
                numero_responsavel: tel_resp,
                numero_jovem: document.getElementById('input-tel-jovem').value.trim(),
                data_nascimento: document.getElementById('input-nascimento').value.trim(),
                data,
                horario,
                irmaos: document.getElementById('input-irmaos').value.trim()
            };
            
            recipients.push(recipient);
            renderRecipients();
            closeModal('modal-form');
            clearForm();
            showToast('Destinat√°rio adicionado!', 'success');
        }

        function clearForm() {
            ['input-jovem', 'input-responsavel', 'input-tel-resp', 'input-tel-jovem', 
             'input-nascimento', 'input-data', 'input-horario', 'input-irmaos'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function renderRecipients() {
            const list = document.getElementById('recipients-list');
            document.getElementById('recipient-count').textContent = recipients.length;
            
            if (recipients.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px 0;">Nenhum destinat√°rio<br><small>Toque no + para adicionar</small></p>';
            } else {
                list.innerHTML = recipients.map((r, i) => `
                    <div class="recipient-card">
                        <div class="recipient-info">
                            <strong>${r.jovem}</strong>
                            <small>üìÖ ${r.data} ‚Ä¢ ‚è∞ ${r.horario}</small>
                        </div>
                        <button class="remove-btn" onclick="removeRecipient(${i})">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
            
            updateUI();
        }

        function removeRecipient(index) {
            if (confirm('Remover este destinat√°rio?')) {
                recipients.splice(index, 1);
                renderRecipients();
            }
        }

        function updateUI() {
            const assistant = document.getElementById('assistant-name').value;
            document.getElementById('generate-btn').disabled = !assistant || recipients.length === 0;
        }

        // ==================== MESSAGES ====================
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const [d, m, y] = birthDate.split('/');
            const birth = new Date(y, m-1, d);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function generateCode(name) {
            const words = name.split(' ').filter(w => w);
            const initials = words.slice(0, 3).map(w => w[0].toUpperCase()).join('');
            return initials + Math.floor(100 + Math.random() * 900);
        }

        function generateMessages() {
            const assistant = document.getElementById('assistant-name').value;
            const local = document.getElementById('location-select').value;
            const section = document.getElementById('messages-section');
            
            section.classList.remove('hidden');
            section.innerHTML = '<div class="card"><h3>üì® Mensagens Geradas</h3></div>';
            
            recipients.forEach(r => {
                const idade = calculateAge(r.data_nascimento);
                const codigo = generateCode(r.jovem);
                const data = { ...r, idade, codigo, assistente: assistant, local };
                
                const message = buildMessage(data);
                const encoded = encodeURIComponent(message);
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <strong>${r.jovem}</strong>
                    <p style="font-size: 14px; color: #64748b; margin: 10px 0;">üì± ${r.numero_responsavel}</p>
                    <details style="margin: 15px 0;">
                        <summary style="cursor: pointer; color: var(--primary); font-weight: bold;">Ver mensagem</summary>
                        <pre style="white-space: pre-wrap; font-size: 12px; background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">${message}</pre>
                    </details>
                    <a href="https://wa.me/${r.numero_responsavel}?text=${encoded}" target="_blank" class="btn" style="background: #22c55e; color: white; text-decoration: none; margin-bottom: 10px;">
                        üì± Enviar WhatsApp
                    </a>
                    <button class="btn btn-secondary" onclick='saveToSheet(this, ${JSON.stringify(data).replace(/'/g, "&apos;")})'>
                        üíæ Salvar na Planilha
                    </button>
                `;
                section.appendChild(card);
            });
        }

        function buildMessage(data) {
            const assistant = ASSISTANT_NAMES[data.assistente] || data.assistente;
            const dayOfWeek = new Date(data.data.split('/').reverse().join('-')).toLocaleDateString('pt-BR', {weekday: 'long', timeZone: 'America/Sao_Paulo'});
            
            let jovemInfo = `*Jovem Convocado:* ${data.jovem}`;
            if (data.idade) jovemInfo += ` (${data.idade} anos)`;
            
            let personalInfo = `${jovemInfo}\n*Respons√°vel:* ${data.responsavel}`;
            if (data.irmaos) personalInfo += `\n*Irm√£os:* ${data.irmaos}`;
            
            const locations = {
                Eldorado: `*Local:* Avenida Jo√£o C√©sar de Oliveira, N¬∫ 953, 2¬∫ andar ‚Äì Eldorado, Contagem.\n\n(Em frente a Caixa Econ√¥mica Federal, ao lado da Oral Centter, pr√≥ximo ao Big Shopping)`,
                Centro: `*Local:* Rua Curitiba, 656, 11¬∞ andar - Centro, Belo Horizonte.\n\n(Em frente a Casa&Video, pr√≥ximo a Marisa)`
            };
            
            return `*CONVOCA√á√ÉO PARA TESTE VOCACIONAL E CADASTRAMENTO GRATUITO AO MERCADO DE TRABALHO*\n---\n${personalInfo}\n---\n*Dados do Agendamento:*\n\n*Data:* ${dayOfWeek}, ${data.data}\n*Hor√°rio:* ${data.horario} (chegar 10min antes)\n---\n${locations[data.local]}\n---\n*Documentos Necess√°rios:*\n \n* RG, CPF ou Certid√£o de Nascimento do jovem.\n* Comprovante de Resid√™ncia.\n\n---\n*C√≥digo do Jovem:* ${data.codigo}\n\n*Aten√ß√£o:* A presen√ßa do respons√°vel junto com o jovem √© indispens√°vel. O c√≥digo j√° foi gerado e a aus√™ncia pode ser interpretada como falta de comprometimento, bloqueando futuras oportunidades pelo projeto social.\n\nAtenciosamente,\n\n*${assistant}*\nCoordena√ß√£o | Empresa Crescer`;
        }

        async function saveToSheet(btn, data) {
    // Linha do IF foi REMOVIDA
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Salvando...';
    
    try {
        console.log('üì§ Salvando:', data);
        
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            mode: 'cors', // Pode at√© tirar isso aqui, j√° que o Apps Script resolve
            body: JSON.stringify(data)
        });
                
                const result = await response.json();
                console.log('üì• Resultado:', result);
                
                if (result.status === 'success') {
                    btn.textContent = '‚úÖ Salvo!';
                    btn.style.background = '#22c55e';
                    showToast('Salvo com sucesso!', 'success');
                    recipients = recipients.filter(r => r.id !== data.id);
                    renderRecipients();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                btn.textContent = '‚ùå Erro';
                btn.style.background = '#ef4444';
                btn.disabled = false;
                showToast('Erro ao salvar: ' + error.message, 'error');
            }
        }

        // ==================== APPOINTMENTS ====================
        async function loadAppointments() {
            const assistant = document.getElementById('assistant-name').value;
            if (!assistant) {
                document.getElementById('appointments-list').innerHTML = '<p style="text-align:center;color:#64748b;padding:40px 0;">Selecione seu nome</p>';
                return;
            }
            
            const list = document.getElementById('appointments-list');
            list.innerHTML = '<div class="loader"></div>';
            
            const today = new Date();
            const dateFilter = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            
            try {
                console.log('üì• Buscando agendamentos...');
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getAppointments&assistant=${assistant}&date=${dateFilter}`);
                const result = await response.json();
                
                console.log('üì¶ Agendamentos recebidos:', result);
                
                if (result.status === 'success') {
                    appointments = result.data;
                    updateStats();
                    renderAppointments();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                list.innerHTML = `<p style="text-align:center;color:#ef4444;padding:40px 0;">Erro: ${error.message}</p>`;
                showToast('Erro ao carregar', 'error');
            }
        }

        function updateStats() {
            const total = appointments.length;
            const confirmed = appointments.filter(a => a.situacao === 'CONFIRMADA' || a.situacao === 'J√Å VEIO').length;
            const pending = appointments.filter(a => !a.situacao || a.situacao === '').length;
            const visited = appointments.filter(a => a.situacao === 'J√Å VEIO').length;
            const conversion = total > 0 ? Math.round((confirmed / total) * 100) : 0;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-visited').textContent = visited;
            document.getElementById('conversion-rate').textContent = conversion + '%';
            document.getElementById('conversion-details').textContent = `${confirmed} de ${total} total`;
        }

        function renderAppointments() {
            const list = document.getElementById('appointments-list');
            let filtered = appointments;
            
            if (currentFilter === 'pending') {
                filtered = appointments.filter(a => !a.situacao || a.situacao === '');
            } else if (currentFilter === 'confirmed') {
                filtered = appointments.filter(a => a.situacao === 'CONFIRMADA');
            } else if (currentFilter === 'visited') {
                filtered = appointments.filter(a => a.situacao === 'J√Å VEIO');
            }
            
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(a => 
                    a.jovem.toLowerCase().includes(searchTerm) || 
                    a.responsavel.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#64748b;padding:40px 0;">Nenhum agendamento encontrado</p>';
                return;
            }
            
            // Ordena por hor√°rio
            filtered.sort((a, b) => {
                if (!a.horario) return 1;
                if (!b.horario) return -1;
                return a.horario.localeCompare(b.horario);
            });
            
            list.innerHTML = filtered.map(appt => {
                const isConfirmed = appt.situacao === 'CONFIRMADA' || appt.situacao === 'J√Å VEIO';
                const isPending = !appt.situacao || appt.situacao === '';
                
                return `
                    <div class="appointment-card ${isConfirmed ? 'confirmed' : ''}">
                        <strong style="font-size: 16px;">${appt.jovem}</strong>
                        <p style="font-size: 14px; color: #64748b; margin: 5px 0;">
                            üë§ ${appt.responsavel}<br>
                            üì± <a href="tel:${appt.telefone_resp}" style="color: var(--primary);">${appt.telefone_resp}</a><br>
                            ‚è∞ ${appt.horario || 'N√£o definido'}
                        </p>
                        <span class="status-badge ${isPending ? 'status-pendente' : 'status-confirmada'}">
                            ${appt.situacao || '‚è≥ Pendente'}
                        </span>
                        <select class="input-field" style="margin-top: 10px; font-size: 14px;" onchange="updateStatus(${appt.rowId}, '${appt.sheetName}', this.value)">
                            <option value="">Atualizar Status</option>
                            <option value="CONFIRMADA">‚úÖ Confirmada</option>
                            <option value="J√Å VEIO">üéØ J√° Veio</option>
                            <option value="CANCELADA">‚ùå Cancelada</option>
                            <option value="REAGENDAR">üîÑ Reagendar</option>
                        </select>
                    </div>
                `;
            }).join('');
        }

        async function updateStatus(rowId, sheetName, newStatus) {
            async function updateStatus(rowId, sheetName, newStatus) {
    // REMOVI O PRIMEIRO IF
    
    if (!newStatus) {
        showToast('‚ùå Selecione um status', 'error');
        return;
    }
    
    const select = event.target;
            }
            
            const select = event.target;
            select.disabled = true;
            select.style.opacity = '0.5';
            
            try {
                console.log('üîÑ Atualizando:', { rowId, sheetName, newStatus });
                
                const payload = {
                    action: 'updateStatus',
                    rowId: parseInt(rowId),
                    sheetName: sheetName,
                    newStatus: newStatus,
                    updatedBy: document.getElementById('assistant-name').value
                };
                
                const response = await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('üì• Resultado:', result);
                
                if (result.status === 'success') {
                    const appt = appointments.find(a => a.rowId === rowId);
                    if (appt) appt.situacao = newStatus;
                    
                    updateStats();
                    renderAppointments();
                    showToast('‚úÖ Status atualizado!', 'success');
                    
                    if (navigator.vibrate) navigator.vibrate(50);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                select.value = '';
                showToast('Erro: ' + error.message, 'error');
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            } finally {
                select.disabled = false;
                select.style.opacity = '1';
            }
        }

        function filterAppointments(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderAppointments();
        }

        function searchAppointments() {
            renderAppointments();
        }

        // ==================== EXPORT ====================
        function exportExcel() {
            if (typeof XLSX === 'undefined') {
                showToast('Biblioteca de exporta√ß√£o n√£o carregada', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(appointments.map(a => ({
                Data: a.data,
                Jovem: a.jovem,
                Respons√°vel: a.responsavel,
                Telefone: a.telefone_resp,
                Hor√°rio: a.horario,
                Status: a.situacao,
                C√≥digo: a.codigo
            })));
            
            XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");
            XLSX.writeFile(wb, `agendamentos_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Excel exportado!', 'success');
        }

        // ==================== TOAST ====================
        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span style="font-size: 20px;">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span style="flex: 1; font-weight: bold;">${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== INIT ====================
        const saved = localStorage.getItem('recipients');
        if (saved) {
            try {
                recipients = JSON.parse(saved);
                renderRecipients();
            } catch (e) {}
        }

        window.addEventListener('beforeunload', () => {
            localStorage.setItem('recipients', JSON.stringify(recipients));
        });

        console.log('‚úÖ Aplicativo iniciado!');
        console.log('üåç Timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone);
    </script>
</body>
</html>